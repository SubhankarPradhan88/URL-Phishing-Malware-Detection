const express = require('express');
const ShortUrl = require('../models/shortUrls');
const shortId = require('shortid');
const phishTankDataset = require('../public/js/phishTankDataset.json');

const router = express.Router();

// Home screen '/' => GET the long & short url list
router.get('/', async (req, res) => {
    const shortUrls = await ShortUrl.find();
    res.render('dashboard', {
        shortId: shortId(),
        shortUrls,
        phishTankDataset
    });
})

// /shortUrls => POST long url
router.post('/shortUrls', async (req, res) => {
    await ShortUrl.create({
        full: req.body.fullUrl,
        short: req.body.shortUrl
    });
    res.redirect('/');
})

// /:shortUrl => GET short urls from DB
router.get('/:shortUrl', async (req, res) => {
    const shortUrl = await ShortUrl.findOne({ short: req.params.shortUrl })  // Search OR Match the short url param in the db
    if (!shortUrl) return res.sendStatus(404);

    shortUrl.clicks++;
    shortUrl.save();

    res.redirect(shortUrl.full);
});

// /delete/:shortUrl => Delete short url from DB
router.get('/delete/:shortUrl', async (req, res) => {
    const shortUrl = await ShortUrl.findOne({ short: req.params.shortUrl })  // Search OR Match the short url param in the db
    if (!shortUrl) return res.sendStatus(404);

    shortUrl.remove();
    shortUrl.save();

    res.redirect('/');
});

module.exports = router;